---
/** 다국어 포스트 상세 페이지 (/{locale}/{category}/{sub_category}/{slug}/) */

import PostLayout from "@/layouts/PostLayout.astro";
import { LOCALES, DEFAULT_LOCALE } from "@/types/common";
import type { Locale } from "@/types/common";
import type { CategorySlug } from "@/types/category";
import { getAllPosts, getPostBySlug } from "@/lib/api/posts";
import { getLocalizedPost } from "@/lib/api/translations";
import { getCategoryLabel, getSubCategoryLabel } from "@/lib/i18n/categories";
import { t } from "@/lib/i18n/translations";

export async function getStaticPaths() {
  const posts = await getAllPosts();
  const nonDefaultLocales = LOCALES.filter((l) => l !== DEFAULT_LOCALE);

  const paths: {
    params: { locale: string; category: string; sub_category: string; slug: string };
    props: { locale: Locale; slug: string; category: CategorySlug; sub_category: string };
  }[] = [];

  for (const locale of nonDefaultLocales) {
    for (const post of posts) {
      paths.push({
        params: {
          locale,
          category: post.category,
          sub_category: post.sub_category,
          slug: post.slug,
        },
        props: {
          locale,
          slug: post.slug,
          category: post.category,
          sub_category: post.sub_category,
        },
      });
    }
  }

  return paths;
}

interface Props {
  locale: Locale;
  slug: string;
  category: CategorySlug;
  sub_category: string;
}

const { locale, slug, category, sub_category } = Astro.props;

const post = await getPostBySlug(slug);

if (!post) {
  return Astro.redirect(`/${locale}/${category}/`, 302);
}

const localizedPost = await getLocalizedPost(post, locale);

const homeLabel = t("nav.home", locale);
const categoryLabel = getCategoryLabel(category, locale);
const subCategoryLabel = getSubCategoryLabel(sub_category, locale);

const canonical = `/${locale}/${category}/${sub_category}/${slug}/`;
const path = `/${category}/${sub_category}/${slug}/`;

const breadcrumbs = [
  { name: homeLabel, url: "/" },
  { name: categoryLabel, url: `/${category}/` },
  { name: subCategoryLabel, url: `/${category}/${sub_category}/` },
  { name: localizedPost.title, url: `/${category}/${sub_category}/${slug}/` },
];
---

<PostLayout
  post={localizedPost}
  locale={locale}
  breadcrumbs={breadcrumbs}
  canonical={canonical}
  path={path}
/>
