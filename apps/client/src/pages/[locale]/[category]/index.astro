---
/**
 * src/pages/[locale]/[category]/index.astro — i18n category index pages
 *
 * Rendering: SSG. One page per (non-default locale) × category combination at build time.
 * Generated routes: /{locale}/{category}/
 *   e.g. /en/delicious/   /ja/cafe/   /zh-CN/travel/  etc.
 *
 * SEO:
 *   - canonical: "/{locale}/{category}/"
 *   - path: "/{category}/" — locale-agnostic for hreflang generation
 *   - BreadcrumbJsonLd: Home > Category (injected into <head>)
 *
 * COST: getLocalizedPost runs per sidebar post — on Supabase each is a single
 *       compound-index lookup (post_id, locale). Acceptable at SSG build time.
 */

import ListLayout from "@/layouts/ListLayout.astro";
import PostCardGrid from "@/components/post/PostCardGrid.astro";
import Pagination from "@/components/navigation/Pagination.astro";
import BreadcrumbJsonLd from "@/components/seo/BreadcrumbJsonLd.astro";
import { LOCALES, DEFAULT_LOCALE } from "@/types/common";
import type { Locale } from "@/types/common";
import type { LocalizedPost } from "@/types/post";
import { CATEGORY_SLUGS } from "@/types/category";
import type { CategorySlug } from "@/types/category";
import {
  getPaginatedPostsByCategory,
  getSponsoredPosts,
  getRecommendedPosts,
} from "@/lib/api/posts";
import { getLocalizedPost } from "@/lib/api/translations";
import { getCategoryLabel } from "@/lib/i18n/categories";
import { t } from "@/lib/i18n/translations";

export async function getStaticPaths() {
  // Cross product: non-default locales × all category slugs.
  const nonDefaultLocales = LOCALES.filter((l) => l !== DEFAULT_LOCALE);
  const paths: {
    params: { locale: string; category: string };
    props: { locale: Locale; category: CategorySlug };
  }[] = [];

  for (const locale of nonDefaultLocales) {
    for (const category of CATEGORY_SLUGS) {
      paths.push({
        params: { locale, category },
        props: { locale, category },
      });
    }
  }

  return paths;
}

interface Props {
  locale: Locale;
  category: CategorySlug;
}

const { locale, category } = Astro.props;

// PERF: Parallel fetch — category posts + sidebar data resolved concurrently.
const [{ posts, totalPages }, sponsored, recommended] = await Promise.all([
  getPaginatedPostsByCategory(category, 1),
  getSponsoredPosts(),
  getRecommendedPosts(),
]);

// Localize all post data for the target locale.
const localizedPosts = await Promise.all(posts.map((p) => getLocalizedPost(p, locale)));
const sponsoredLocalized: LocalizedPost[] = await Promise.all(
  sponsored.map((p) => getLocalizedPost(p, locale))
);
const recommendedLocalized: LocalizedPost[] = await Promise.all(
  recommended.map((p) => getLocalizedPost(p, locale))
);

const categoryLabel = getCategoryLabel(category, locale);
const homeLabel = t("nav.home", locale);

// canonical is the full locale-prefixed URL for this page.
const canonical = `/${locale}/${category}/`;
// path is locale-agnostic — BaseHead > Hreflang uses this to build all variants.
const path = `/${category}/`;

const breadcrumbItems = [
  { name: homeLabel, url: "/" },
  { name: categoryLabel, url: `/${category}/` },
];

const pageTitle = `${categoryLabel} - seeun log`;
const pageDescription = `세은로그 ${categoryLabel} 카테고리 — 커플이 직접 다녀온 ${categoryLabel} 장소 리뷰 모음.`;
---

<ListLayout
  title={pageTitle}
  description={pageDescription}
  canonical={canonical}
  path={path}
  locale={locale}
  sponsoredPosts={sponsoredLocalized}
  recommendedPosts={recommendedLocalized}
>
  {/* SEO: BreadcrumbJsonLd injected into <head> via named slot */}
  <BreadcrumbJsonLd slot="head" items={breadcrumbItems} />

  <PostCardGrid posts={localizedPosts} locale={locale} />

  {totalPages > 1 && (
    <Pagination
      currentPage={1}
      totalPages={totalPages}
      baseUrl={canonical}
      locale={locale}
    />
  )}
</ListLayout>
