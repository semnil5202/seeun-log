---
/** 다국어 카테고리 인덱스 (/{locale}/{category}/) */

import ListLayout from "@/layouts/ListLayout.astro";
import PostCardGrid from "@/features/post-feed/components/PostCardGrid.astro";
import BreadcrumbJsonLd from "@/shared/components/seo/BreadcrumbJsonLd.astro";
import { LOCALES, DEFAULT_LOCALE } from "@/shared/types/common";
import type { Locale } from "@/shared/types/common";
import type { LocalizedPost } from "@/shared/types/post";
import { CATEGORY_SLUGS } from "@/shared/types/category";
import type { CategorySlug } from "@/shared/types/category";
import {
  getPaginatedPostsByCategory,
  getSponsoredPosts,
} from "@/features/post-feed/api/posts";
import { getLocalizedPost } from "@/features/post-feed/api/translations";
import { getCategoryLabel } from "@/shared/lib/i18n/categories";
import { t } from "@/shared/lib/i18n/translations";
import SubCategoryTabs from "@/shared/components/navigation/SubCategoryTabs.astro";

export async function getStaticPaths() {
  const nonDefaultLocales = LOCALES.filter((l) => l !== DEFAULT_LOCALE);
  const paths: {
    params: { locale: string; category: string };
    props: { locale: Locale; category: CategorySlug };
  }[] = [];

  for (const locale of nonDefaultLocales) {
    for (const category of CATEGORY_SLUGS) {
      paths.push({
        params: { locale, category },
        props: { locale, category },
      });
    }
  }

  return paths;
}

interface Props {
  locale: Locale;
  category: CategorySlug;
}

const { locale, category } = Astro.props;

const [{ posts, totalPages }, sponsored] = await Promise.all([
  getPaginatedPostsByCategory(category, 1),
  getSponsoredPosts(category),
]);

const localizedPosts = await Promise.all(posts.map((p) => getLocalizedPost(p, locale)));
const sponsoredLocalized: LocalizedPost[] = await Promise.all(
  sponsored.map((p) => getLocalizedPost(p, locale))
);

const categoryLabel = getCategoryLabel(category, locale);
const homeLabel = t("nav.home", locale);

const canonical = `/${locale}/${category}/`;
const path = `/${category}/`;

const breadcrumbItems = [
  { name: homeLabel, url: "/" },
  { name: categoryLabel, url: `/${category}/` },
];

const pageTitle = `${categoryLabel} - seeun log`;
const pageDescription = `세은로그 ${categoryLabel} 카테고리 — 커플이 직접 다녀온 ${categoryLabel} 장소 리뷰 모음.`;
---

<ListLayout
  title={pageTitle}
  description={pageDescription}
  canonical={canonical}
  path={path}
  locale={locale}
  sponsoredPosts={sponsoredLocalized}
>
  <BreadcrumbJsonLd slot="head" items={breadcrumbItems} />

  <SubCategoryTabs category={category} locale={locale} />

  <PostCardGrid
    posts={localizedPosts}
    locale={locale}
    feedEndpoint={`/api/feed/${locale}/${category}/`}
    hasNextPage={totalPages > 1}
    sponsoredLabel={t("post.sponsored", locale)}
  />
</ListLayout>
