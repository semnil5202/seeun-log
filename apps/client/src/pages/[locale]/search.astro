---
/** 다국어 검색 페이지 (/{locale}/search/) */

import ListLayout from "@/layouts/ListLayout.astro";
import SearchUI from "@/features/search/components/SearchUI.astro";
import { buildSearchData } from "@/features/search/api/search-data";
import { LOCALES, DEFAULT_LOCALE } from "@/shared/types/common";
import type { Locale } from "@/shared/types/common";
import type { LocalizedPost } from "@/shared/types/post";
import { getAllPosts, getSponsoredPosts } from "@/features/post-feed/api/posts";
import { getLocalizedPost } from "@/features/post-feed/api/translations";
import { t } from "@/shared/lib/i18n/translations";

export const getStaticPaths = async () => {
  const nonDefaultLocales = LOCALES.filter((l) => l !== DEFAULT_LOCALE);

  return nonDefaultLocales.map((locale) => ({
    params: { locale },
    props: { locale },
  }));
};

interface Props {
  locale: Locale;
}

const { locale } = Astro.props;

const [allPosts, sponsored] = await Promise.all([
  getAllPosts(),
  getSponsoredPosts(),
]);

const localizedPosts = await Promise.all(allPosts.map((p) => getLocalizedPost(p, locale)));
const sponsoredLocalized: LocalizedPost[] = await Promise.all(
  sponsored.map((p) => getLocalizedPost(p, locale))
);

const { searchData, suggestedKeywords } = buildSearchData(localizedPosts, locale);

const canonical = `/${locale}/search/`;
const path = "/search/";

const placeholderText = t("search.placeholder", locale);
const noResultsText = t("search.noResults", locale);
const noResultsHintText = t("search.noResultsHint", locale);
const resultsText = t("search.results", locale);
const suggestedText = t("search.suggested", locale);
const sponsoredLabel = t("post.sponsored", locale);
const navSearch = t("nav.search", locale);
const pageTitle = `${navSearch} - seeun log`;
---

<ListLayout
  title={pageTitle}
  description="세은로그 검색 — 맛집, 카페, 여행 게시글을 검색합니다."
  canonical={canonical}
  path={path}
  locale={locale}
  sponsoredPosts={sponsoredLocalized}
>
  <Fragment slot="head">
    <meta name="robots" content="noindex, follow" />
  </Fragment>

  <SearchUI
    searchData={searchData}
    suggestedKeywords={suggestedKeywords}
    placeholderText={placeholderText}
    noResultsText={noResultsText}
    noResultsHintText={noResultsHintText}
    resultsText={resultsText}
    suggestedText={suggestedText}
    sponsoredLabel={sponsoredLabel}
  />
</ListLayout>
