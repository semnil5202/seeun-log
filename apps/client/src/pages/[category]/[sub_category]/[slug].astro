---
/** 한국어 포스트 상세 페이지 (/{category}/{sub_category}/{slug}/) */

import PostLayout from "@/layouts/PostLayout.astro";
import { DEFAULT_LOCALE } from "@/types/common";
import type { LocalizedPost } from "@/types/post";
import type { CategorySlug } from "@/types/category";
import { getAllPosts, getPostBySlug } from "@/lib/api/posts";
import { getCategoryLabel, getSubCategoryLabel } from "@/lib/i18n/categories";

export async function getStaticPaths() {
  const posts = await getAllPosts();

  return posts.map((post) => ({
    params: {
      category: post.category,
      sub_category: post.sub_category,
      slug: post.slug,
    },
    props: {
      slug: post.slug,
      category: post.category,
      sub_category: post.sub_category,
    },
  }));
}

interface Props {
  slug: string;
  category: CategorySlug;
  sub_category: string;
}

const { slug, category, sub_category } = Astro.props;
const locale = DEFAULT_LOCALE;

const post = await getPostBySlug(slug);

if (!post) {
  return Astro.redirect(`/${category}/`, 302);
}

const localizedPost: LocalizedPost = { ...post, locale };

const categoryLabel = getCategoryLabel(category, locale);
const subCategoryLabel = getSubCategoryLabel(sub_category, locale);
const canonical = `/${category}/${sub_category}/${slug}/`;
const path = `/${category}/${sub_category}/${slug}/`;

const breadcrumbs = [
  { name: "홈", url: "/" },
  { name: categoryLabel, url: `/${category}/` },
  { name: subCategoryLabel, url: `/${category}/${sub_category}/` },
  { name: post.title, url: `/${category}/${sub_category}/${slug}/` },
];
---

<PostLayout
  post={localizedPost}
  locale={locale}
  breadcrumbs={breadcrumbs}
  canonical={canonical}
  path={path}
/>
