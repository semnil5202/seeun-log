---
/** 한국어 서브카테고리 인덱스 (/{category}/{sub_category}/) */

import ListLayout from "@/layouts/ListLayout.astro";
import PostCardGrid from "@/features/post-feed/components/PostCardGrid.astro";
import BreadcrumbJsonLd from "@/shared/components/seo/BreadcrumbJsonLd.astro";
import { DEFAULT_LOCALE } from "@/shared/types/common";
import type { LocalizedPost } from "@/shared/types/post";
import { CATEGORY_SLUGS, SUB_CATEGORY_MAP } from "@/shared/types/category";
import type { CategorySlug } from "@/shared/types/category";
import {
  getPaginatedPostsBySubCategory,
  getSponsoredPosts,
} from "@/features/post-feed/api/posts";
import { getCategoryLabel, getSubCategoryLabel } from "@/shared/lib/i18n/categories";
import { t } from "@/shared/lib/i18n/translations";
import SubCategoryTabs from "@/shared/components/navigation/SubCategoryTabs.astro";

export const getStaticPaths = async () => {
  const paths: { params: { category: string; sub_category: string }; props: { category: CategorySlug; sub_category: string } }[] = [];

  for (const category of CATEGORY_SLUGS) {
    for (const sub_category of SUB_CATEGORY_MAP[category]) {
      paths.push({
        params: { category, sub_category },
        props: { category, sub_category },
      });
    }
  }

  return paths;
};

interface Props {
  category: CategorySlug;
  sub_category: string;
}

const { category, sub_category } = Astro.props;
const locale = DEFAULT_LOCALE;

const [{ posts, totalPages }, sponsored] = await Promise.all([
  getPaginatedPostsBySubCategory(category, sub_category, 1),
  getSponsoredPosts(category, sub_category),
]);

const sponsoredLocalized: LocalizedPost[] = sponsored.map((p) => ({ ...p, locale }));

const categoryLabel = getCategoryLabel(category, locale);
const subCategoryLabel = getSubCategoryLabel(sub_category, locale);
const canonical = `/${category}/${sub_category}/`;
const path = `/${category}/${sub_category}/`;

const breadcrumbItems = [
  { name: "홈", url: "/" },
  { name: categoryLabel, url: `/${category}/` },
  { name: subCategoryLabel, url: `/${category}/${sub_category}/` },
];

const pageTitle = `${subCategoryLabel} - ${categoryLabel} - 세은로그`;
const pageDescription = `세은로그 ${categoryLabel} > ${subCategoryLabel} — 커플이 직접 다녀온 ${subCategoryLabel} 장소 리뷰 모음.`;
---

<ListLayout
  title={pageTitle}
  description={pageDescription}
  canonical={canonical}
  path={path}
  locale={locale}
  sponsoredPosts={sponsoredLocalized}
>
  <BreadcrumbJsonLd slot="head" items={breadcrumbItems} />

  <SubCategoryTabs category={category} activeSubCategory={sub_category} locale={locale} />

  <PostCardGrid
    posts={posts}
    locale={locale}
    feedEndpoint={`/api/feed/${locale}/${category}/${sub_category}/`}
    hasNextPage={totalPages > 1}
    sponsoredLabel={t("post.sponsored", locale)}
  />
</ListLayout>
