---
/** 포스트 상세 레이아웃. 메인 피드와 동일한 3-column 구조. */

import Layout from "@/layouts/Layout.astro";
import LeftSidebar from "@/shared/components/layout/LeftSidebar.astro";
import RightSidebar from "@/shared/components/layout/RightSidebar.astro";
import BreadcrumbJsonLd from "@/shared/components/seo/BreadcrumbJsonLd.astro";
import BlogPostingJsonLd from "@/shared/components/seo/BlogPostingJsonLd.astro";
import SponsoredBadge from "@/shared/components/ui/SponsoredBadge.astro";
import SponsoredPostList from "@/shared/components/layout/SponsoredPostList.astro";
import { getSponsoredPosts, getPostsBySubCategory } from "@/features/post-feed/api/posts";
import { getLocalizedPost } from "@/features/post-feed/api/translations";
import { getLocalePath } from "@/shared/lib/i18n/locales";
import type { LocalizedPost } from "@/shared/types/post";
import type { Locale } from "@/shared/types/common";
import type { BreadcrumbItem } from "@/shared/types/seo";
import { t } from "@/shared/lib/i18n/translations";

interface Props {
  post: LocalizedPost;
  locale: Locale;
  breadcrumbs: BreadcrumbItem[];
  canonical: string;
  path: string;
  categoryLabel: string;
  subCategoryLabel: string;
}

const { post, locale, breadcrumbs, canonical, path, categoryLabel, subCategoryLabel } = Astro.props;

const [sponsoredRaw, subCategoryPosts] = await Promise.all([
  getSponsoredPosts(post.category, post.sub_category),
  getPostsBySubCategory(post.category, post.sub_category),
]);
const sponsoredLocalized = await Promise.all(
  sponsoredRaw.map((p) => getLocalizedPost(p, locale)),
);

const currentIdx = subCategoryPosts.findIndex((p) => p.slug === post.slug);
const sliceStart = Math.max(0, currentIdx - 2);
const sliceEnd = Math.min(subCategoryPosts.length, currentIdx + 3);
const nearbyPosts = subCategoryPosts.slice(sliceStart, sliceEnd);
const nearbyLocalized = await Promise.all(
  nearbyPosts.map((p) => getLocalizedPost(p, locale)),
);

const moreLabel = t("post.more", locale);
const subCategoryHref = getLocalePath(`/${post.category}/${post.sub_category}/`, locale);

const fullStars = Math.min(5, Math.max(0, Math.round(post.rating)));
const emptyStars = 5 - fullStars;

const blogPosting = {
  title: post.title,
  description: post.description,
  datePublished: post.created_at,
  dateModified: post.updated_at,
  image: post.thumbnail,
  url: canonical,
  authorName: "세은로그",
};

const reviewSchema =
  post.place_name
    ? {
        itemReviewed: {
          type: "Restaurant" as const,
          name: post.place_name,
          address: post.address ?? "",
        },
        reviewRating: post.rating,
        authorName: "세은로그",
      }
    : undefined;

const ratingLabel = t("post.rating", locale);
const sponsoredLabel = t("post.sponsored", locale);

const publishDate = new Date(post.created_at).toLocaleDateString(locale, {
  year: "numeric",
  month: "long",
  day: "numeric",
});

const AD_PLACEHOLDER = `\n\n<div class="not-prose w-full h-[300px] bg-gray-100 rounded-xl mx-auto my-8 flex items-center justify-center" role="complementary" aria-label="Advertisement"><span class="text-body2 text-gray-400 select-none">In-Article Adsense</span></div>\n\n`;

function insertInArticleAds(markdown: string): string {
  const parts = markdown.split(/(?=^## )/m);
  if (parts.length <= 2) return markdown;

  const secondIdx = 1;
  const lastIdx = parts.length - 1;

  return parts
    .map((part, i) => {
      if (i === secondIdx || (i === lastIdx && lastIdx !== secondIdx)) {
        return AD_PLACEHOLDER + part;
      }
      return part;
    })
    .join("");
}

const contentWithAds = insertInArticleAds(post.content);
---

<Layout
  title={post.title}
  description={post.description}
  canonical={canonical}
  path={path}
  locale={locale}
  ogImage={post.thumbnail}
  type="article"
>
  <Fragment slot="head">
    <BreadcrumbJsonLd items={breadcrumbs} />
    <BlogPostingJsonLd posting={blogPosting} review={reviewSchema} />
  </Fragment>

  <div class="max-w-screen-xl mx-auto px-4 lg:px-6">
    <div class="grid grid-cols-1 lg:grid-cols-[180px_1fr_300px] gap-0 lg:gap-8 min-h-screen">

      <LeftSidebar locale={locale} />

      <main class="min-w-0 py-6">

        <div
          class="bg-gray-100 rounded-xl flex items-center justify-center mb-6 mx-auto w-[300px] h-[50px] lg:w-[468px] lg:h-[60px]"
          role="complementary"
          aria-label="Advertisement"
        >
          <span class="text-body2 text-gray-400 select-none">Fixed Adsense</span>
        </div>

        <article itemscope itemtype="https://schema.org/BlogPosting">

          {(post.is_sponsored || post.is_recommended) && (
            <div class="flex gap-2 mb-3">
              {post.is_sponsored && (
                <SponsoredBadge label={sponsoredLabel} />
              )}
              {post.is_recommended && (
                <SponsoredBadge label={sponsoredLabel} />
              )}
            </div>
          )}

          <h1
            class="text-2xl sm:text-3xl font-bold text-gray-900 leading-tight mb-4"
            itemprop="headline"
          >
            {post.title}
          </h1>

          <div class="flex flex-wrap items-center gap-x-4 gap-y-1 text-sm text-gray-500 mb-5">
            <time
              datetime={post.created_at}
              itemprop="datePublished"
              class="flex items-center gap-1"
            >
              <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" />
              </svg>
              {publishDate}
            </time>
          </div>

          <div class="aspect-video w-full overflow-hidden rounded-xl mb-6 bg-gray-100">
            <img
              src={post.thumbnail}
              alt={post.title}
              width="1280"
              height="720"
              loading="eager"
              fetchpriority="high"
              decoding="async"
              class="w-full h-full object-cover"
              itemprop="image"
            />
          </div>

          {post.place_name && (
            <div
              class="bg-gray-50 border border-gray-200 rounded-xl p-5 mb-6"
              itemscope
              itemtype="https://schema.org/LocalBusiness"
            >
              <dl class="space-y-3 text-sm">
                <div class="flex items-baseline gap-3">
                  <dt class="shrink-0 w-16 text-gray-500 font-medium">카테고리</dt>
                  <dd class="text-gray-900">{categoryLabel} › {subCategoryLabel}</dd>
                </div>
                <div class="flex items-baseline gap-3">
                  <dt class="shrink-0 w-16 text-gray-500 font-medium">장소</dt>
                  <dd class="text-gray-900 font-semibold" itemprop="name">{post.place_name}</dd>
                </div>
                {post.address && (
                  <div class="flex items-baseline gap-3">
                    <dt class="shrink-0 w-16 text-gray-500 font-medium">주소</dt>
                    <dd class="text-gray-900" itemprop="address">{post.address}</dd>
                  </div>
                )}
                {post.price_level && (
                  <div class="flex items-baseline gap-3">
                    <dt class="shrink-0 w-16 text-gray-500 font-medium">가격대</dt>
                    <dd class="text-gray-900">{post.price_level}</dd>
                  </div>
                )}
                {post.rating > 0 && (
                  <div
                    class="flex items-center gap-3"
                    itemprop="reviewRating"
                    itemscope
                    itemtype="https://schema.org/Rating"
                  >
                    <dt class="shrink-0 w-16 text-gray-500 font-medium">{ratingLabel}</dt>
                    <dd class="flex items-center gap-1">
                      <meta itemprop="ratingValue" content={String(post.rating)} />
                      <meta itemprop="bestRating" content="5" />
                      {Array.from({ length: fullStars }).map(() => (
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-yellow-400" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                          <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                        </svg>
                      ))}
                      {Array.from({ length: emptyStars }).map(() => (
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-gray-300" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                          <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                        </svg>
                      ))}
                      <span class="text-xs font-semibold text-gray-900 ml-0.5">
                        {post.rating.toFixed(1)}
                      </span>
                    </dd>
                  </div>
                )}
              </dl>
            </div>
          )}

          <div
            class="prose prose-gray prose-lg max-w-none
                   prose-headings:font-bold prose-headings:text-gray-900
                   prose-a:text-primary-600 prose-a:no-underline hover:prose-a:underline
                   prose-img:rounded-xl prose-img:shadow-sm
                   prose-blockquote:border-primary-400 prose-blockquote:text-gray-600"
            itemprop="articleBody"
            set:html={contentWithAds}
          />

        </article>

        {nearbyLocalized.length > 1 && (
          <section class="mt-12">
            <div class="flex items-center justify-between pb-3 border-b border-gray-200">
              <h2 class="text-[16px] lg:text-[18px] font-semibold text-gray-900">
                {categoryLabel} › {subCategoryLabel} 글
              </h2>
              <a
                href={subCategoryHref}
                class="text-sm text-gray-500 hover:text-primary-500 transition-colors duration-150"
              >
                {moreLabel} &gt;
              </a>
            </div>

            <ul role="list">
              {nearbyLocalized.map((item) => {
                const isCurrent = item.slug === post.slug;
                const href = getLocalePath(
                  `/${item.category}/${item.sub_category}/${item.slug}/`,
                  locale,
                );
                return (
                  <li class:list={[
                    "border-b border-gray-100",
                    isCurrent && "border-l-2 border-l-primary-500",
                  ]}>
                    <a
                      href={href}
                      class:list={[
                        "flex items-center gap-4 py-4 hover:bg-gray-50 transition-colors duration-150",
                        isCurrent ? "pl-3" : "pl-0",
                      ]}
                      aria-current={isCurrent ? "page" : undefined}
                    >
                      <div class="flex-1 min-w-0">
                        <span class:list={[
                          "block text-base font-semibold leading-snug mb-1 truncate",
                          isCurrent ? "text-primary-600" : "text-gray-900",
                        ]}>
                          {item.title}
                        </span>
                        <p class="text-sm text-gray-500 line-clamp-2 leading-relaxed">
                          {item.description}
                        </p>
                      </div>
                      <div class="shrink-0 w-20 h-20 rounded-lg overflow-hidden bg-gray-100">
                        <img
                          src={item.thumbnail}
                          alt={item.title}
                          width={80}
                          height={80}
                          loading="lazy"
                          decoding="async"
                          class="w-full h-full object-cover"
                        />
                      </div>
                    </a>
                  </li>
                );
              })}
            </ul>
          </section>
        )}

        <div class="block lg:hidden mt-12">
          <SponsoredPostList
            locale={locale}
            posts={sponsoredLocalized}
            currentSlug={post.slug}
          />
        </div>

      </main>

      <RightSidebar
        locale={locale}
        sponsoredPosts={sponsoredLocalized}
        currentSlug={post.slug}
      />

    </div>
  </div>
</Layout>
