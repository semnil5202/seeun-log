---
/**
 * src/layouts/PostLayout.astro — Post detail page layout
 *
 * Single-column layout for individual post pages. Does NOT use ThreeColumnLayout
 * or sidebars — post detail pages are reader-focused with full-width content.
 *
 * Rendering: SSG. Built at deploy time per post × locale combination.
 *
 * Composition:
 *   Layout.astro (HTML shell + head + header + footer)
 *     <article> (semantic post content container)
 *       Breadcrumb
 *       Thumbnail (LCP — eager loading, explicit dimensions)
 *       Metadata (title, date, place, rating, address)
 *       Content body (set:html for markdown-sourced HTML)
 *
 * SEO:
 *   - BlogPostingJsonLd + BreadcrumbJsonLd injected into <head> via named slot
 *   - canonical + path passed through to Layout > BaseHead
 *   - <article> tag for semantic post identity
 *   - type="article" for Open Graph og:type
 *
 * CLS prevention:
 *   - Thumbnail: explicit width=1280 height=720, aspect-video container
 *   - Rating stars: fixed-width SVG icons prevent width recalculation
 *
 * Security:
 *   - set:html is only used on content authored by the site owner (not user input).
 *     This is safe; no user-generated HTML is rendered through this layout.
 *
 * Props:
 *   post           — LocalizedPost (post data enriched with translation)
 *   locale         — Locale for rendering labels and URL paths
 *   breadcrumbs    — BreadcrumbItem[] for nav + JSON-LD
 *   canonical      — Full locale-aware URL path for this page
 *   path           — Locale-agnostic path for hreflang generation
 */

import Layout from "@/layouts/Layout.astro";
import Breadcrumb from "@/components/navigation/Breadcrumb.astro";
import BreadcrumbJsonLd from "@/components/seo/BreadcrumbJsonLd.astro";
import BlogPostingJsonLd from "@/components/seo/BlogPostingJsonLd.astro";
import type { LocalizedPost } from "@/types/post";
import type { Locale } from "@/types/common";
import type { BreadcrumbItem } from "@/types/seo";
import { t } from "@/lib/i18n/translations";

interface Props {
  post: LocalizedPost;
  locale: Locale;
  breadcrumbs: BreadcrumbItem[];
  canonical: string;
  path: string;
}

const { post, locale, breadcrumbs, canonical, path } = Astro.props;

// --- Rating helpers -------------------------------------------------------

/**
 * Converts a numeric rating (0–5) into a count of full, half, and empty stars.
 * We use integer-only ratings for simplicity; halves are not currently in the schema.
 */
const fullStars = Math.min(5, Math.max(0, Math.round(post.rating)));
const emptyStars = 5 - fullStars;

// --- BlogPosting schema data ---------------------------------------------

const blogPosting = {
  title: post.title,
  description: post.description,
  datePublished: post.created_at,
  dateModified: post.updated_at,
  image: post.thumbnail,
  url: canonical,
  authorName: "세은로그",
};

// Build Review schema only when place_name and address are available.
const reviewSchema =
  post.place_name
    ? {
        itemReviewed: {
          type: "Restaurant" as const,
          name: post.place_name,
          address: post.address ?? "",
        },
        reviewRating: post.rating,
        authorName: "세은로그",
      }
    : undefined;

// --- UI labels -----------------------------------------------------------

const ratingLabel = t("post.rating", locale);
const sponsoredLabel = t("post.sponsored", locale);
const editorsPickLabel = t("post.editorsPick", locale);

// Formatted publish date — use build locale for number formatting.
const publishDate = new Date(post.created_at).toLocaleDateString(locale, {
  year: "numeric",
  month: "long",
  day: "numeric",
});
---

<Layout
  title={post.title}
  description={post.description}
  canonical={canonical}
  path={path}
  locale={locale}
  ogImage={post.thumbnail}
  type="article"
>
  {/* SEO: JSON-LD injected into <head> via the named "head" slot */}
  <Fragment slot="head">
    <BreadcrumbJsonLd items={breadcrumbs} />
    <BlogPostingJsonLd posting={blogPosting} review={reviewSchema} />
  </Fragment>

  {/*
    Single-column post content container.
    max-w-3xl keeps line lengths readable (~75 chars at 16px).
    PERF: no grid layout overhead — just a single centered column.
  */}
  <div class="max-w-screen-xl mx-auto px-4 lg:px-6">
    <div class="max-w-3xl mx-auto py-6">

      {/* Breadcrumb navigation — above the article fold */}
      <Breadcrumb items={breadcrumbs} locale={locale} />

      <article class="mt-6" itemscope itemtype="https://schema.org/BlogPosting">

        {/* --- Badges (Sponsored / Editor's Pick) --- */}
        {(post.is_sponsored || post.is_recommended) && (
          <div class="flex gap-2 mb-3">
            {post.is_sponsored && (
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-semibold bg-amber-100 text-amber-800">
                {sponsoredLabel}
              </span>
            )}
            {post.is_recommended && (
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-semibold bg-rose-100 text-rose-700">
                {editorsPickLabel}
              </span>
            )}
          </div>
        )}

        {/* --- Post title --- */}
        {/*
          LCP candidate on desktop: the title may be the largest text block above fold.
          h1 is only used once per page (this component), satisfying heading hierarchy.
        */}
        <h1
          class="text-2xl sm:text-3xl font-bold text-gray-900 leading-tight mb-4"
          itemprop="headline"
        >
          {post.title}
        </h1>

        {/* --- Metadata row: publish date + rating --- */}
        <div class="flex flex-wrap items-center gap-x-4 gap-y-1 text-sm text-gray-500 mb-5">
          <time
            datetime={post.created_at}
            itemprop="datePublished"
            class="flex items-center gap-1"
          >
            {/* Calendar icon */}
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
              <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" />
            </svg>
            {publishDate}
          </time>

          {post.rating > 0 && (
            <div
              class="flex items-center gap-1"
              aria-label={`${ratingLabel}: ${post.rating} / 5`}
              itemprop="reviewRating"
              itemscope
              itemtype="https://schema.org/Rating"
            >
              <meta itemprop="ratingValue" content={String(post.rating)} />
              <meta itemprop="bestRating" content="5" />
              {/* Full stars */}
              {Array.from({ length: fullStars }).map(() => (
                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-amber-400" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                  <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                </svg>
              ))}
              {/* Empty stars */}
              {Array.from({ length: emptyStars }).map(() => (
                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-gray-300" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                  <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                </svg>
              ))}
              <span class="text-xs font-medium text-gray-600 ml-0.5">
                {post.rating.toFixed(1)}
              </span>
            </div>
          )}
        </div>

        {/* --- Thumbnail image (LCP element) ---
          CLS: explicit width/height + aspect-video container prevents layout shift.
          LCP: loading="eager" + fetchpriority="high" — this is always above the fold on detail pages.
          PERF: object-cover inside a fixed-ratio container avoids reflow.
        */}
        <div class="aspect-video w-full overflow-hidden rounded-xl mb-6 bg-gray-100">
          <img
            src={post.thumbnail}
            alt={post.title}
            width="1280"
            height="720"
            loading="eager"
            fetchpriority="high"
            decoding="async"
            class="w-full h-full object-cover"
            itemprop="image"
          />
        </div>

        {/* --- Place info (place_name, address, price_level) --- */}
        {post.place_name && (
          <div
            class="bg-gray-50 border border-gray-100 rounded-xl p-4 mb-6 text-sm"
            itemscope
            itemtype="https://schema.org/LocalBusiness"
          >
            <p class="font-semibold text-gray-900 mb-1" itemprop="name">
              {post.place_name}
            </p>
            {post.address && (
              <p class="text-gray-500 flex items-start gap-1" itemprop="address">
                {/* Location pin icon */}
                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 mt-0.5 shrink-0 text-rose-400" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                  <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
                </svg>
                {post.address}
              </p>
            )}
            {post.price_level && (
              <p class="text-gray-500 mt-1 flex items-center gap-1">
                {/* Price tag icon */}
                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 shrink-0 text-green-500" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                  <path fill-rule="evenodd" d="M17.707 9.293a1 1 0 010 1.414l-7 7a1 1 0 01-1.414 0l-7-7A.997.997 0 012 10V5a3 3 0 013-3h5c.256 0 .512.098.707.293l7 7zM5 6a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
                </svg>
                {post.price_level}
              </p>
            )}
          </div>
        )}

        {/* --- Post body content ---
          SECURITY: set:html is used here for content authored by the blog owner only.
          This is NOT user-generated content — there is no XSS vector here.
          On Supabase migration, ensure admin sanitizes HTML before storage.
        */}
        <div
          class="prose prose-gray prose-lg max-w-none
                 prose-headings:font-bold prose-headings:text-gray-900
                 prose-a:text-rose-600 prose-a:no-underline hover:prose-a:underline
                 prose-img:rounded-xl prose-img:shadow-sm
                 prose-blockquote:border-rose-400 prose-blockquote:text-gray-600"
          itemprop="articleBody"
          set:html={post.content}
        />

      </article>
    </div>
  </div>
</Layout>
