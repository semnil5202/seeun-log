---
/** 포스트 상세 레이아웃. 메인 피드와 동일한 3-column 구조. */

import Layout from "@/layouts/Layout.astro";
import LeftSidebar from "@/shared/components/layout/LeftSidebar.astro";
import RightSidebar from "@/shared/components/layout/RightSidebar.astro";
import BreadcrumbJsonLd from "@/shared/components/seo/BreadcrumbJsonLd.astro";
import BlogPostingJsonLd from "@/shared/components/seo/BlogPostingJsonLd.astro";
import SponsoredPostList from "@/shared/components/layout/SponsoredPostList.astro";
import FixedAdsense from "@/shared/components/ad/FixedAdsense.astro";
import PostBadges from "@/features/post-detail/components/PostBadges.astro";
import PlaceInfoCard from "@/features/post-detail/components/PlaceInfoCard.astro";
import NearbyPostList from "@/features/post-detail/components/NearbyPostList.astro";
import { getSponsoredPosts, getPostsBySubCategory } from "@/features/post-feed/api/posts";
import { getLocalizedPost } from "@/features/post-feed/api/translations";
import { getLocalePath } from "@/shared/lib/i18n/locales";
import { t } from "@/shared/lib/i18n/translations";
import { formatDate } from "@/shared/lib/date";
import { insertInArticleAds } from "@/features/post-detail/lib/ads";
import { buildBlogPostingSchema, buildReviewSchema } from "@/features/post-detail/lib/schema";
import type { LocalizedPost } from "@/shared/types/post";
import type { Locale } from "@/shared/types/common";
import type { BreadcrumbItem } from "@/shared/types/seo";

interface Props {
  post: LocalizedPost;
  locale: Locale;
  breadcrumbs: BreadcrumbItem[];
  canonical: string;
  path: string;
  categoryLabel: string;
  subCategoryLabel: string;
}

const { post, locale, breadcrumbs, canonical, path, categoryLabel, subCategoryLabel } = Astro.props;

const [sponsoredRaw, subCategoryPosts] = await Promise.all([
  getSponsoredPosts(post.category, post.sub_category),
  getPostsBySubCategory(post.category, post.sub_category),
]);
const sponsoredLocalized = await Promise.all(
  sponsoredRaw.map((p) => getLocalizedPost(p, locale)),
);

const currentIdx = subCategoryPosts.findIndex((p) => p.slug === post.slug);
const sliceStart = Math.max(0, currentIdx - 2);
const sliceEnd = Math.min(subCategoryPosts.length, currentIdx + 3);
const nearbyPosts = subCategoryPosts.slice(sliceStart, sliceEnd);
const nearbyLocalized = await Promise.all(
  nearbyPosts.map((p) => getLocalizedPost(p, locale)),
);

const subCategoryHref = getLocalePath(`/${post.category}/${post.sub_category}/`, locale);
const publishDate = formatDate(post.created_at, locale);
const contentWithAds = insertInArticleAds(post.content);
const blogPosting = buildBlogPostingSchema(post, canonical);
const reviewSchema = buildReviewSchema(post);
const sponsoredLabel = t("post.sponsored", locale);
---

<Layout
  title={post.title}
  description={post.description}
  canonical={canonical}
  path={path}
  locale={locale}
  ogImage={post.thumbnail}
  type="article"
>
  <Fragment slot="head">
    <BreadcrumbJsonLd items={breadcrumbs} />
    <BlogPostingJsonLd posting={blogPosting} review={reviewSchema} />
  </Fragment>

  <div class="max-w-screen-xl mx-auto px-4 lg:px-6">
    <div class="grid grid-cols-1 lg:grid-cols-[180px_1fr_300px] gap-0 lg:gap-8 min-h-screen">

      <LeftSidebar locale={locale} />

      <main class="min-w-0 py-6">

        <FixedAdsense variant="post-top" />

        <article itemscope itemtype="https://schema.org/BlogPosting">

          <PostBadges
            isSponsored={post.is_sponsored}
            isRecommended={post.is_recommended}
            label={sponsoredLabel}
          />

          <h1
            class="text-2xl sm:text-3xl font-bold text-gray-900 leading-tight mb-4"
            itemprop="headline"
          >
            {post.title}
          </h1>

          <div class="flex flex-wrap items-center gap-x-4 gap-y-1 text-sm text-gray-500 mb-5">
            <time
              datetime={post.created_at}
              itemprop="datePublished"
              class="flex items-center gap-1"
            >
              <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" />
              </svg>
              {publishDate}
            </time>
          </div>

          <div class="aspect-video w-full overflow-hidden rounded-xl mb-6 bg-gray-100">
            <img
              src={post.thumbnail}
              alt={post.title}
              width="1280"
              height="720"
              loading="eager"
              fetchpriority="high"
              decoding="async"
              class="w-full h-full object-cover"
              itemprop="image"
            />
          </div>

          {post.place_name && (
            <PlaceInfoCard
              categoryLabel={categoryLabel}
              subCategoryLabel={subCategoryLabel}
              placeName={post.place_name}
              address={post.address}
              priceLevel={post.price_level}
              rating={post.rating}
              locale={locale}
            />
          )}

          <div
            class="prose prose-gray prose-lg max-w-none
                   prose-headings:font-bold prose-headings:text-gray-900
                   prose-a:text-primary-600 prose-a:no-underline hover:prose-a:underline
                   prose-img:rounded-xl prose-img:shadow-sm
                   prose-blockquote:border-primary-400 prose-blockquote:text-gray-600"
            itemprop="articleBody"
            set:html={contentWithAds}
          />

        </article>

        <NearbyPostList
          posts={nearbyLocalized}
          currentSlug={post.slug}
          categoryLabel={categoryLabel}
          subCategoryLabel={subCategoryLabel}
          moreLabel={t("post.more", locale)}
          subCategoryHref={subCategoryHref}
          locale={locale}
        />

        <div class="block lg:hidden mt-12">
          <SponsoredPostList
            locale={locale}
            posts={sponsoredLocalized}
            currentSlug={post.slug}
          />
        </div>

      </main>

      <RightSidebar
        locale={locale}
        sponsoredPosts={sponsoredLocalized}
        currentSlug={post.slug}
      />

    </div>
  </div>
</Layout>
